<Window x:Class="Blindodon.Views.AccountSelectWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:Blindodon.ViewModels"
        xmlns:converters="clr-namespace:Blindodon.Converters"
        mc:Ignorable="d"
        Title="Select Account - Blindodon"
        Height="500" Width="500"
        MinHeight="400" MinWidth="400"
        WindowStartupLocation="CenterScreen"
        Background="{StaticResource BackgroundBrush}"
        Foreground="{StaticResource TextPrimaryBrush}"
        KeyDown="Window_KeyDown"
        Loaded="Window_Loaded">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>
        <converters:InitialsConverter x:Key="InitialsConverter"/>
        <converters:StringToVisibilityConverter x:Key="StringToVisibilityConverter"/>
    </Window.Resources>

    <Grid Margin="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,24">
            <TextBlock Text="Select Account"
                       FontSize="{StaticResource FontSizeXLarge}"
                       FontWeight="Bold"
                       AutomationProperties.HeadingLevel="Level1"/>
            <TextBlock Text="Choose an account to log in with, or add a new one"
                       FontSize="{StaticResource FontSizeNormal}"
                       Foreground="{StaticResource TextSecondaryBrush}"
                       Margin="0,8,0,0"/>
        </StackPanel>

        <!-- Account List (when accounts exist) -->
        <ListBox x:Name="AccountListBox"
                 Grid.Row="1"
                 ItemsSource="{Binding Accounts}"
                 SelectedItem="{Binding SelectedAccount}"
                 Visibility="{Binding HasAccounts, Converter={StaticResource BoolToVisibilityConverter}}"
                 VirtualizingPanel.IsVirtualizing="True"
                 AutomationProperties.Name="Saved accounts"
                 KeyDown="AccountListBox_KeyDown"
                 MouseDoubleClick="AccountListBox_MouseDoubleClick">
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <Grid Margin="8" AutomationProperties.Name="{Binding AccessibilityLabel}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="48"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Avatar placeholder -->
                        <Border Grid.Column="0"
                                Width="40"
                                Height="40"
                                CornerRadius="20"
                                Background="{StaticResource SurfaceBrush}"
                                VerticalAlignment="Center"
                                Margin="0,0,8,0">
                            <TextBlock Text="{Binding Initials}"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       FontWeight="Bold"
                                       FontSize="{StaticResource FontSizeNormal}"/>
                        </Border>

                        <!-- Account info -->
                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding EffectiveDisplayName}"
                                           FontWeight="Bold"
                                           FontSize="{StaticResource FontSizeNormal}"/>
                                <TextBlock Text=" (default)"
                                           Foreground="{StaticResource TextSecondaryBrush}"
                                           Visibility="{Binding IsDefault, Converter={StaticResource BoolToVisibilityConverter}}"/>
                            </StackPanel>
                            <TextBlock Text="{Binding InstanceDomain}"
                                       Foreground="{StaticResource TextSecondaryBrush}"
                                       FontSize="{StaticResource FontSizeSmall}"/>
                        </StackPanel>

                        <!-- Delete button -->
                        <Button Grid.Column="2"
                                Content="Remove"
                                Command="{Binding DataContext.DeleteAccountCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                CommandParameter="{Binding}"
                                Padding="8,4"
                                VerticalAlignment="Center"
                                AutomationProperties.Name="Remove this account"/>
                    </Grid>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <!-- Empty State (when no accounts) -->
        <StackPanel Grid.Row="1"
                    Visibility="{Binding HasAccounts, Converter={StaticResource InverseBoolToVisibilityConverter}}"
                    VerticalAlignment="Center"
                    HorizontalAlignment="Center">
            <TextBlock Text="No accounts saved"
                       FontSize="{StaticResource FontSizeLarge}"
                       HorizontalAlignment="Center"
                       Margin="0,0,0,8"/>
            <TextBlock Text="Add your first Mastodon account to get started."
                       Foreground="{StaticResource TextSecondaryBrush}"
                       HorizontalAlignment="Center"
                       TextWrapping="Wrap"
                       TextAlignment="Center"
                       MaxWidth="300"/>
        </StackPanel>

        <!-- Status Message -->
        <TextBlock Grid.Row="2"
                   Text="{Binding StatusMessage}"
                   TextWrapping="Wrap"
                   Margin="0,16,0,0"
                   Foreground="{StaticResource TextSecondaryBrush}"
                   AutomationProperties.LiveSetting="Polite"
                   Visibility="{Binding StatusMessage, Converter={StaticResource StringToVisibilityConverter}, FallbackValue=Collapsed}"/>

        <!-- Action Buttons -->
        <Grid Grid.Row="3" Margin="0,24,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Add Account Button -->
            <Button x:Name="AddAccountButton"
                    Grid.Column="0"
                    Content="Add Account"
                    Command="{Binding AddAccountCommand}"
                    HorizontalAlignment="Left"
                    Padding="16,8"
                    AutomationProperties.Name="Add a new Mastodon account"/>

            <!-- Cancel Button -->
            <Button Grid.Column="1"
                    Content="Cancel"
                    Click="CancelButton_Click"
                    Margin="0,0,8,0"
                    Padding="16,8"
                    AutomationProperties.Name="Cancel and exit"/>

            <!-- Login Button -->
            <Button x:Name="LoginButton"
                    Grid.Column="2"
                    Content="Login"
                    Command="{Binding LoginCommand}"
                    Padding="16,8"
                    AutomationProperties.Name="Login with selected account"
                    IsEnabled="{Binding CanLogin}"/>
        </Grid>

        <!-- Loading Overlay -->
        <Border Grid.RowSpan="4"
                Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}"
                Background="#80000000">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <TextBlock Text="Please wait..."
                           FontSize="{StaticResource FontSizeLarge}"
                           HorizontalAlignment="Center"
                           AutomationProperties.LiveSetting="Polite"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
